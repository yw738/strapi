import{bT as U,dO as W,q as k,u as L,a as $,dP as q,j as e,l as x,I as D,aG as G,dQ as z,dR as N,dS as I,o as B,dT as T,cm as Q,cX as Y,B as X,h as Z,dU as _,dD as A,dV as J,dW as K,dX as ee,cY as F,c as te,d as v,c6 as y,dI as se,ck as ne,r as S,dY as ae,dZ as oe,d_ as re,d$ as ie,dA as ce,dB as de,bI as le,dF as ue,dG as E,e0 as pe}from"./strapi-y0akA7lV.js";import{F as me}from"./Input-r7RCMVRQ.js";import{getDocumentStatus as H}from"./EditViewPage-BL3jAlsY.js";import"./usePrev-B71R5_47.js";import"./objects-DL4QYPH-.js";import"./getEmptyImage-CjqolaH3.js";import"./ComponentIcon-BCASJu6q.js";const he=()=>{const[{query:s}]=k(),{formatMessage:i}=L(),o=T("BackButton",r=>r.canGoBack),c=T("BackButton",r=>r.goBack),l=T("BackButton",r=>r.history),n=T("BackButton",r=>r.currentLocationIndex),p=o?l.at(n-2):void 0,u={pathname:"..",search:Q.stringify(s,{encode:!1})},h=p??u,a=r=>{if(o){r.preventDefault(),c();return}};return e.jsx(D,{variant:"ghost",tag:Y,relative:"path",to:h,onClick:a,label:i({id:"content-manager.preview.header.close",defaultMessage:"Close preview"}),children:e.jsx(X,{})})},ge=()=>{const s=m("PreviewHeader",n=>n.document),i=m("PreviewHeader",n=>n.schema),o=m("PreviewHeader",n=>n.meta);if(!(i?.options?.draftAndPublish??!1))return null;const l=H(s,o);return e.jsx(_,{status:l,size:"XS"})},fe=()=>{const{formatMessage:s}=L(),[{query:i},o]=k(),c=m("PreviewHeader",a=>a.document),l=m("PreviewHeader",a=>a.schema),n=m("PreviewHeader",a=>a.meta),p=l?.options?.draftAndPublish??!1,u=H(c,n),h=a=>{(a==="published"||a==="draft")&&o({status:a},"push",!0)};return p?e.jsx(A.Root,{variant:"simple",value:i.status||"draft",onValueChange:h,children:e.jsxs(A.List,{"aria-label":s({id:"preview.tabs.label",defaultMessage:"Document status"}),children:[e.jsx(M,{value:"draft",children:s({id:"content-manager.containers.List.draft",defaultMessage:"draft"})}),e.jsx(M,{value:"published",disabled:u==="draft",children:s({id:"content-manager.containers.List.published",defaultMessage:"published"})})]})}):null},xe=()=>{const s=m("PreviewHeader",d=>d.title),i=m("PreviewHeader",d=>d.document),o=m("PreviewHeader",d=>d.schema),c=m("PreviewHeader",d=>d.meta),l=U("PreviewHeader",d=>d.plugins),n=W("PreviewHeader",d=>d.onPreview),[{query:p}]=k(),{formatMessage:u}=L(),{toggleNotification:h}=$(),{copy:a}=q(),r=()=>{a(window.location.href),h({message:u({id:"content-manager.preview.copy.success",defaultMessage:"Copied preview link"}),type:"success"})},t=o.options?.draftAndPublish??!1,f={activeTab:p.status??null,collectionType:o.kind==="collectionType"?"collection-types":"single-types",model:o.uid,documentId:i.documentId,document:i,meta:c,onPreview:n,fromPreview:!0};return e.jsxs(x,{height:"48px",gap:4,background:"neutral0",borderColor:"neutral150",tag:"header",children:[e.jsxs(we,{height:"100%",paddingLeft:2,paddingRight:4,children:[e.jsx(he,{}),e.jsx(ve,{tag:"h1",title:s,maxWidth:"200px",fontSize:2,paddingLeft:2,paddingRight:3,fontWeight:600,children:s}),e.jsx(ge,{})]}),e.jsxs(x,{flex:1,paddingRight:2,gap:2,justifyContent:t?"space-between":"flex-end",children:[e.jsx(x,{flex:"1 1 70%",children:e.jsx(fe,{})}),e.jsxs(x,{gap:2,children:[e.jsx(D,{type:"button",label:u({id:"preview.copy.label",defaultMessage:"Copy preview link"}),onClick:r,children:e.jsx(G,{})}),e.jsx(z,{area:"preview.actions"}),e.jsx(N,{props:f,descriptions:l["content-manager"].apis.getDocumentActions("preview"),children:d=>{const C=d.filter(j=>[j.position].flat().includes("preview")),[g,w]=C;return!g&&!w?null:g&&w?e.jsxs(e.Fragment,{children:[e.jsx(I,{...w,variant:w.variant||"secondary"}),e.jsx(I,{...g,variant:g.variant||"default"})]}):e.jsx(I,{...g,variant:g.variant||"secondary"})}})]})]})]})},ve=B(Z)`
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
`,M=B(A.Trigger)`
  text-transform: uppercase;
`,we=B(x)`
  border-right: 1px solid ${({theme:s})=>s.colors.neutral150};
`,[je,m]=J("PreviewPage"),Pe=B(pe)`
  will-change: transform;
  rotate: ${s=>s.isSideEditorOpen?"0deg":"180deg"};
  transition: rotate 0.2s ease-in-out;
`,be=()=>{const s=ne(),{formatMessage:i}=L(),o=S.useRef(null),[c,l]=S.useState(!0),{slug:n,id:p,collectionType:u}=F(),[{query:h}]=k(),a=S.useMemo(()=>ae(h),[h]);if(!u)throw new Error("Could not find collectionType in url params");if(!n)throw new Error("Could not find model in url params");if(u===oe&&!p)throw new Error("Could not find documentId in url params");const r=re({params:{contentType:n},query:{documentId:p,locale:a.locale,status:a.status}}),t=ie({model:n,collectionType:u,documentId:p,params:a}),f=ce(n);if((r.isLoading||f.isLoading||t.isLoading)&&!t.document?.documentId)return e.jsx(v.Loading,{});const C=t.getInitialFormValues();if(r.error||f.error||!t.document||!t.meta||!t.schema||!C)return e.jsx(v.Error,{});if(!r.data?.data?.url)return e.jsx(v.NoData,{});const g=t.getTitle(f.edit.settings.mainField),w=(P,b)=>E(t.schema?.attributes,t.components,{status:t.document?.status,...b}).validateSync(P,{abortEarly:!1}),j=r.data.data.url,O=()=>{o?.current?.contentWindow?.postMessage({type:"strapiUpdate"},new URL(o.current.src).origin)},R=window.strapi.features.isEnabled("cms-advanced-preview");return e.jsxs(e.Fragment,{children:[e.jsx(v.Title,{children:i({id:"content-manager.preview.page-title",defaultMessage:"{contentType} preview"},{contentType:g})}),e.jsx(de,{initialDocument:{documentId:p||"",model:n,collectionType:u},onPreview:O,children:e.jsx(je,{url:j,document:t.document,title:g,meta:t.meta,schema:t.schema,layout:f.edit,children:e.jsx(le,{method:"PUT",disabled:h.status==="published"&&t&&t.document.status==="published",initialValues:t.getInitialFormValues(),initialErrors:s?.state?.forceValidation?w(C,{}):{},height:"100%",validate:(P,b)=>E(t.schema?.attributes,t.components,{status:t.document?.status,...b}).validate(P,{abortEarly:!1}),children:({resetForm:P})=>e.jsxs(x,{direction:"column",height:"100%",alignItems:"stretch",children:[e.jsx(ue,{onProceed:P}),e.jsx(xe,{}),e.jsxs(x,{flex:1,overflow:"auto",alignItems:"stretch",children:[R&&e.jsx(y,{overflow:"auto",width:c?"50%":0,borderWidth:"0 1px 0 0",borderColor:"neutral150",paddingTop:6,paddingBottom:6,paddingLeft:c?6:0,paddingRight:c?6:0,transition:"all 0.2s ease-in-out",children:e.jsx(me,{layout:f.edit.layout,document:t,hasBackground:!1})}),e.jsxs(y,{position:"relative",flex:1,height:"100%",overflow:"hidden",children:[e.jsx(y,{"data-testid":"preview-iframe",ref:o,src:j,title:i({id:"content-manager.preview.panel.title",defaultMessage:"Preview"}),width:"100%",height:"100%",borderWidth:0,tag:"iframe"},j),R&&e.jsx(D,{variant:"tertiary",label:i(c?{id:"content-manager.preview.content.close-editor",defaultMessage:"Close editor"}:{id:"content-manager.preview.content.open-editor",defaultMessage:"Open editor"}),onClick:()=>l(b=>!b),position:"absolute",top:2,left:2,children:e.jsx(Pe,{isSideEditorOpen:c})})]})]})]})})})})]})},ye=()=>{const{slug:s}=F(),{permissions:i=[],isLoading:o,error:c}=te([{action:"plugin::content-manager.explorer.read",subject:s},{action:"plugin::content-manager.explorer.update",subject:s},{action:"plugin::content-manager.explorer.publish",subject:s}]);return o?e.jsx(v.Loading,{}):c||!s?e.jsx(y,{height:"100vh",width:"100vw",position:"fixed",top:0,left:0,zIndex:2,background:"neutral0",children:e.jsx(v.Error,{})}):e.jsx(y,{height:"100vh",width:"100vw",position:"fixed",top:0,left:0,zIndex:2,background:"neutral0",children:e.jsx(v.Protect,{permissions:i.filter(l=>l.action.includes("explorer.read")),children:e.jsx(se,{permissions:i,children:e.jsx(be,{})})})})},Ae=()=>e.jsx(K,{children:e.jsx(ee,{children:e.jsx(ye,{})})});export{Ae as ProtectedPreviewPage,m as usePreviewContext};
